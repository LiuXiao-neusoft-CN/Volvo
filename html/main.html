<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="../css/common.css">
  <title>Title</title>
  <style>
    body {
      min-width: 1440px;
    }
    li {
      list-style: none;
    }
    td {
      position: relative;
    }
    button {
      border: 0;
      outline: 0;
    }

    .nav-bar {
      width: 100%;
      height: 6.25em;
      min-width: 1490px;
      background-color: #333333;
    }
    .page-container {
      position: relative;
      min-width: 1490px;
      width: 100%;
    }
    .menu-list {
      border-top: 2px solid #FFFFFF;
      min-width: 200px;
      max-width: 200px;
      width: 8%;
      height: 100%;
      background-color: #515151;
    }
    .page-content {
      position: absolute;
      top: 1.8em;
      right: 0;
      left: 210px;
      bottom: 0;
    }
    .menu-lv1 .menu-item {
      color: #FFFFFF;
      height: 3em;
      font-size: 1.1em;
      font-weight: 600;
      border-bottom: 2px solid #FFFFFF;
      text-align: left;
      width: 100%;
      padding: 0 5% 0 15%;
      line-height: 3em;
    }
    .menu-lv2 .menu-item {
      color: #FFFFFF;
      height: 2.8em;
      font-size: 1em;
      font-weight: 600;
      border-bottom: 2px solid #FFFFFF;
      text-align: left;
      width: 100%;
      padding: 0 5% 0 15%;
      line-height: 2.8em;
    }
    .menu-lv2 {
      display: none
    }
    .menu-item:hover {
      background-color: #44aaee;
    }


    .tag-container {
      border-top: 2px solid #FFFFFF;
      position: absolute;
      top: 0;
      right: 0;
      left: 210px;
      height: 2em;
      line-height: 2em;
    }
    .tag-container > .tag {
      margin-left: 1px;
      padding: 0.1em 0.2em 2px 0.6em;
      position: relative;
      bottom: 0;
      height: 100%;
      border-top: 2px solid #515151;
      border-left: 2px solid #515151;;
      border-right: 2px solid #515151;
      border-top-left-radius: 0.45em;
      border-top-right-radius: 0.45em;
      background-color: #D1D1D1;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.75);
    }
    .tag:first-child {
      margin: 0;
    }
    .tag > .tag-name {
      font-size: 0.9em;
      margin-right: 0.3em;
    }
    .tag > .tag-close {
      font-size: 0.9em;
      font-weight: 600;
      color: #EE0000;
    }
    .page-content {
      position: absolute;
      left: 210px;
      right: 10px;
      bottom: 10px;
      top: 30px;
      border: 2px solid #333333;
      padding: 0.5em;
      border-top-right-radius: 0.5em;
      border-bottom-right-radius: 0.5em;
      border-bottom-left-radius: 0.5em;
    }
    .tag-active {
      background-color: #FFFFFF !important;
      box-shadow: none !important;
      z-index: 100;
      border-bottom: 2px solid #FFFFFF;
    }
    .tag:hover {
      background-color: #FFFFFF;
      box-shadow: none;
    }
    table {
      border-collapse: collapse;
    }
    .user-form {
      width: 100%;
      padding-bottom: 0.5em;
    }
    .user-form > .form-title, .user-table > .table-title {
      width: 100%;
      font-size: 1.25em;
      font-weight: 600;
      position: relative;
      height: 1.5em;
      line-height: 1.5em;
    }
    .form-title > .title, .table-title > .title {
      height: 100%;
      position: absolute;
      left: 0.8em;
      top: 0;
    }
    .form-title > .blue-block, .table-title > .blue-block {
      height: 64%;
      width: 0.4em;
      position: absolute;
      left: 0;
      top: 18%;
      background-color: #44aaee;
    }
    .user-form > .form-body, .user-table > .table-body {
      margin-top: 0.475em;
      width: 100%;
      border: 2px solid #333333;
      border-radius: 0.5em;
      padding: 0.5em 0.75em;
    }
    .form-body table, tbody, tr, .table-body table, tbody, tr {
      width: 100%;
    }
    .form-body tr{
      height: 3em;
    }
    .form-body td {
      width: 25%;
    }
    .table-head th {
      border: 1px solid #33aaef;
      border-right: 1px solid #FFFFFF;
      border-left: 1px solid #FFFFFF;
      border-bottom: 0;
      background-color: #33aaef;
      color: #FFFFFF
    }
    .table-head th:first-child {
      border-left: 1px solid #33aaef;
    }
    .table-head th:last-child {
      border-right: 1px solid #33aaef;
    }
    .table-body tr {
      height: 1.8em;
    }
    .table-body th, td {
      text-align: center;
    }
    .table-body > .table-data {
      width: 100%;
      overflow-y: scroll;
    }
    .input-container {
      position: relative;
      width: 100%;
      height: 2em;
    }
    .input-container > .input-label, .input-container > .input-content {
      height: 100%;
      position: absolute;
      font-size: 0.9125em;
      line-height: 2.5em;
      top: 0;
    }
    .input-container > .input-label {
      font-size: 0.8em;
      left: 0;
      width: 35%;
      padding-right: 0.875em;
      text-align: right;
      min-width: 120px;
    }
    .input-container > .input-content {
      left: 35%;
      width: 60%;
    }
    .input-content input,  .input-content select {
      height: 100%;
      width: 100%;
      font-size: 1em;
      padding: 0 0.5em;
      border-radius: 0.25em;
      border: 1px solid #515151;
      outline: none;
    }
    .page-content td[colspan='2'] .input-label {
      width: 17.5%;
    }
    .page-content td[colspan='2'] .input-content {
      left: 17.5%;
      width: 80%;
    }

    .table-data tr:nth-child(odd)
    {
      background:#D2D2D2;
    }
    .table-data tr:nth-child(even)
    {
      background:#FFFFFF;
    }
    .table-footer {
      position: absolute;
      padding: 0.5em;
      bottom: 0.5em;
      right: 2.5em;
      display: none;
    }
    .table-footer > .current-page{
      float: right;
      height: 100%;
      line-height: 2.25em;
    }
    .table-footer > .page-num {
      height: 2.2em;
      line-height: 2.2em;
      padding: 0 0.8em;
      border: 1px solid #333333;
      float: right;
      margin-left: 0.3em;
      text-align: center;
      cursor: pointer;
    }
    .page-num:hover {
      background-color: #ccbbcc;
    }
    .pagnition-prev, .pagnition-next {
      margin-left: 0.5em;
      height: 2.6em;
      width: 6em;
      text-align: center;
      float: right;
    }

    .window-mask {
      position: fixed;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
    }
    .window-mask > .window-container {
      position: absolute;
      left: 10%;
      right: 10%;
      top: 10%;
      border-radius: 0.8em;
      border: 1px solid #515151;
      box-shadow: 0 0 1em #515151;
    }
    .window-container > .window-nav-bar {
      position: absolute;
      background-color: #66ccff;
      border-top-left-radius: 0.8em;
      border-top-right-radius: 0.8em;
      box-shadow: 0 0.1em 4px #999999;
      top: 0;
      height: 42px;
      z-index: 100;
      width: 100%;
    }
    .window-container > .window-content {
      position: absolute;
      background-color: #FFFFFF;
      border-bottom-left-radius: 0.8em;
      border-bottom-right-radius: 0.8em;
      top: 42px;
      bottom: 0;
      width: 100%;
      padding: 1.5em;
    }

    .window-content .input-label {
      width: 40%;
    }
    .window-content .input-content {
      left: 40%;
      width: 60%;
    }
    #closeMask {
      color: #EE0000;
      font-size: 1.5em;
      font-weight: 600;
      position: absolute;
      right: 0.5em;
      padding: 6px;
      height: 100%;
      top: 0;
      cursor: pointer;
    }
    .window-content td[colspan='2'] .input-label {
      width: 20%;
    }
    .window-content td[colspan='2'] .input-content {
      left: 20%;
      width: 80%;
    }

    .window-content button {
      font-size: 1em;
      color: #FFFFFF;
      letter-spacing: 4px;
      border-radius: 0.5em;
      width: 15%;
      height: 2.75em;
      position: absolute;
      bottom: 1.5em;
    }
    .user-form button {
      font-size: 1em;
      color: #FFFFFF;
      letter-spacing: 4px;
      border-radius: 0.5em;
      width: 40%;
      height: 2.75em;
    }
    .user-form button:first-child {
      margin-left: 5%;
    }
    .user-form button:last-child {
      margin-left: 5%;
    }
    .user-table .table-data button {
      height: 100%;
      width: 30%;
      font-size: 1em;
      border-radius: 0.25em;
      padding: 0.2em 0;
      color: #333333;
    }
    .btn-act {
      opacity: 0.6;
    }

    .c-blue {
      background-color: #41c3f5;
    }
    .c-green {
      background-color: #1fc711;
    }
    .c-confirm {
      background-color: #1dcd9e;
    }
    .c-cancel {
      background-color: #ff6767;
    }
    .c-delete {
      background-color: #fb3e3e;
    }
  </style>
</head>
<body>
  <div class="window-mask">
    <div class="window-container">
      <div class="window-nav-bar">
        <div id="closeMask">×</div>
      </div>
      <div class="window-content">

      </div>
    </div>
  </div>

  <div class="nav-bar">

  </div>
  <div class="page-container">
    <div class="menu-list">
      <ul class="menu-lv1">
        <li>
          <div class="menu-item pointer" style="display: none">
            路面施工监控
          </div>
          <ul class="menu-lv2">
            <li>
              <div class="menu-item pointer" nav-to="roadMonitor">
                路面施工监控1
              </div>
            </li>
            <li>
              <div class="menu-item pointer" nav-to="roadMonitor">
                路面施工监控2
              </div>
            </li>
          </ul>
        </li>
        <li>
          <div class="menu-item pointer" nav-to="historyMonitor" style="display: none">
            历史路面监控
          </div>
        </li>
        <li>
          <div class="menu-item pointer" nav-to="roadView" style="display: none">
            路面指标监控
          </div>
        </li>
        <li>
          <div class="menu-item pointer" nav-to="projectManagement">
            施工项目管理
          </div>
        </li>
        <li>
          <div class="menu-item pointer" nav-to="contextAnalyse" style="display: none">
            报表分析
          </div>
        </li>
        <li>
          <div class="menu-item pointer" nav-to="equipmentManagement">
            设备管理
          </div>
        </li>
        <li>
          <div class="menu-item pointer" nav-to="characterManagement">
            资源分配
          </div>
        </li>
        <li>
          <div class="menu-item pointer" nav-to="userManagement">
            用户管理
          </div>
        </li>
        <li>
          <div class="menu-item pointer" nav-to="authorityManagement">
            权限管理
          </div>
        </li>
        <li>
          <div class="menu-item pointer" nav-to="labelManagement">
            标段管理
          </div>
        </li>
        <li>
          <div class="menu-item pointer" nav-to="carManagement">
            车辆管理
          </div>
        </li>
      </ul>
    </div>
    <div class="tag-container">

    </div>
    <div class="page-content">

    </div>
  </div>
</body>
<script type="text/javascript" src="../js/jquery-3.3.1.min.js"></script>
<script>
  // 用户行为标识符
  var ACTION = "";
  // 全局DATA存储
  var ROW_SETS = null;
  // 操作对象存储
  var TARGET_ROW_SET = null;

  var confirmEvent = new Function();
  var cancelEvent = new Function();
  var updateEvent = new Function();
  var deleteEvent = new Function();
  var queryEvent = new Function();
  var insertEvent = new Function();

  function cleanEvent() {
    // 清空新页面的方法参数
    ACTION = "";
    confirmEvent = new Function();
    cancelEvent = new Function();
    updateEvent = new Function();
    deleteEvent = new Function();
    queryEvent = new Function();
    insertEvent = new Function();
  }

  $(document).ready(function() {
      $.ajax({
          url: '/login/getMenu',
          dataType: "json",
          type:"post",
          async: false,
          data: {
              userId: window.sessionStorage.getItem('USER_ID')
          },
          success:function (response) {
              console.log(response);
              var menuHtml = '';
              for (var i = 0; i < response.length; i ++) {
                  menuHtml += '<li>\
                                <div class="menu-item pointer" nav-to="' + response[i].menuPath + '">\
                                  ' + response[i].menuName + '\
                                </div>\
                              </li>'
              }
              $('.menu-lv1').html(menuHtml);
              onMenuLoad();
          },
          error: function(error) {

          }
      });
      onMenuLoad();

      function onMenuLoad() {
          $('.page-container').height($(window).height() - $('.nav-bar').height());

          $('.menu-item').on('click', function() {

              // 跳转方法
              if ($(this).attr('nav-to')) {
                  cleanEvent();
                  var menuClicked = $(this).html().trim();
                  var route = $(this).attr('nav-to');
                  var curHtml = $(this).html().trim();
                  $('.tag').removeClass('tag-active');
                  $('.tag').each(function() {
                      if ($(this).find('.tag-name').html().trim() === curHtml) {
                          $(this).addClass('tag-active');
                      }
                  });


                  if ( !$(this).parent().hasClass('menu-active') ) {
                      $(this).parent().addClass('menu-active');
                      $('.tag-container').append( Tag(menuClicked) );
                      $('.tag-close').off().on('click', function(event) {
                          event.stopPropagation();
                          $(this).parents('.tag').fadeOut(100, function() {
                              var tag2close = $(this);
                              $('.menu-active').each(function() {
                                  if ($(this).find('.menu-item').html().trim() ===
                                      tag2close.find('.tag-name').html().trim()) {

                                      $(this).removeClass('menu-active');
                                      tag2close.fadeOut(100, function() {
                                          tag2close.remove();
                                          if ( $('.tag-active').length === 0 ) {
                                              $('.tag').eq(0).click();
                                              if ($('.tag').eq(0).length === 0)
                                                  $('.page-content').html('');
                                          }
                                      });
                                  }
                              });
                          })
                      });

                      $('.tag').off().on('click', function() {
                          cleanEvent();
                          $('.tag').removeClass('tag-active');
                          var tagClicked = $(this).addClass('tag-active');
                          $('.menu-active').each(function() {
                              if ($(this).find('.menu-item').html().trim() === tagClicked.find('.tag-name').html().trim()) {
                                  $(this).find('.menu-item').trigger('click');
                              }
                          });
                      });
                  }
                  $('.page-content').load('views/' + route + '.html', function() {

                      // 初始化表格高度
                      $('.table-head').width($('.table-data').find('table').width() + 2);
                      $('.table-body').height($('.page-content').height() - $('.user-form').height() - $('.table-title').height() - 36);
                      $('.table-data').height($('.table-body').height() - $('.table-title').height() - $('.table-footer').height());

                      // 全局button设置点击事件
                      $('button').off('mousedown').on('mousedown', function() {
                          $(this).addClass('btn-act');
                      });
                      $('button').off('mouseup').on('mouseup', function() {
                          $(this).removeClass('btn-act');
                      });

                      // insert按键自带属性。
                      $('.insert').on('click', function() {
                          ACTION = 'INSERT';
                          $('.window-mask').fadeIn(200);
                          $('.window-content').html('<div class="user-form">' +  $('.user-form').html() + '</div>' ).find('button').remove();
                          var formHeight = $('.window-content').find('.user-form').height();
                          $('.window-content').height(formHeight + 64).append('<button class="confirm c-confirm" style="left:34.5%">确认</button><button class="cancel c-cancel" style="left:50.5%">取消</button>');
                          $('.confirm').on('click', function() {
                              confirmEvent($('.window-content').find('.user-form'));

                              $('.window-mask').fadeOut(200).find('.window-content').html('');
                          });

                          $('.cancel').on('click', function() {
                              cancelEvent($('.window-content').find('.user-form'));

                              $('.window-mask').fadeOut(200).find('.window-content').html('');
                          });

                          insertEvent($('.window-content').find('.user-form'));
                      });

                      // query按键自带属性
                      $('.query').on('click', function() {
                          var dataObj = {};
                          $('.user-form').find("[bind-to]").each(function() {
                              var param = $(this).attr('bind-to');
                              var value = $(this).val();
                              if (value)
                                  dataObj[param] = value;
                          });
                          this.dataSets = dataObj;
                          queryEvent(this);
                      });

                  });
              } else {
                  if ($(this).parent().hasClass('menu-active')) {
                      $(this).parent().removeClass('menu-active').find('ul').stop().slideUp(200);
                  } else {
                      $(this).parent().addClass('menu-active').find('ul').stop().slideDown(200);
                  }
              }
          });
          console.log('<===== 成功执行menuOnload事件 =====>');

          $(".menu-item[nav-to='characterManagement']").click();

          $('#closeMask').on('click', function() {
              $('.window-mask').fadeOut(200).find('.window-content').html('');
          });
      }
  });

  var Tag = function(tagName) {
    return $('<span class="tag tag-active">\n' +
        '      <span class="tag-name">' + tagName + '</span>\n' +
        '      <span class="tag-close pointer">×</span>\n' +
        '  </span>');
  };

  // 动态绑定数据的方法
  function bindData(el, data, mainKey, hasControl) {
    // 绑定全局对象
    ROW_SETS = data;

    var htmlStr = '';
    if (!hasControl)
      hasControl = false;
    for (var i = 0; i <data.length; i++) {
      var d = data[i];

      var trHtml = "<tr p-key='" + d[mainKey] + "'>";
      $(el).find('th[bind-to]').each(function() {
        var pam = $(this).attr('bind-to');
        trHtml += '<td bind-to="' + pam + '">' + d[pam] + '</td>'
      });
      if (hasControl) {
        trHtml += '  <td>' +
          '            <button class="update c-green">修改</button>' +
          '            <button class="delete c-delete">删除</button>' +
          '          </td>' +
          '        </tr>'
      } else {
        trHtml += '</tr>'
      }
      htmlStr += trHtml;
    }
    $(el).find('tbody').html(htmlStr);

    // update按键自带属性
    $('.update').on('click', function() {
      ACTION = 'UPDATE';
      $('.window-mask').fadeIn(200);
      $('.window-content').html('<div class="user-form">' +  $('.user-form').html() + '</div>' ).find('button').remove();
      var formHeight = $('.window-content').find('.user-form').height();
      $('.window-content').height(formHeight + 64).append('<button class="confirm c-confirm" style="left:34.5%">确认</button><button class="cancel c-cancel" style="left:50.5%">取消</button>');

      $('.confirm').on('click', function() {
        confirmEvent($('.window-content').find('.user-form'));

        $('.window-mask').fadeOut(200).find('.window-content').html('');
      });

      $('.cancel').on('click', function() {
        cancelEvent($('.window-content').find('.user-form'));

        $('.window-mask').fadeOut(200).find('.window-content').html('');
      });
      updateEvent(this);
    });

    $('.delete').on('click', function() {
      deleteEvent(this);
    });
  }

  function getTarget(pkName, pk) {
    for (var rsI = 0; rsI < ROW_SETS.length; rsI ++) {
      var o = ROW_SETS[ rsI ];
      if (ROW_SETS[pkName] === pk)
        return o;
    }
  }
  
  function dataFilter(data, filter) {
    var filtered = [];
    var temp = data;

    for (var pam in filter) {
      // 清空被过滤的数据
      filtered = [];

      // 查询条件
      var condition = filter[pam];
      for (var i = 0; i < temp.length; i ++) {
        var obj = temp[i];
        var val = obj[pam] + '';
        if (val.indexOf(condition) >= 0) {
          filtered.push(obj);
        }
      }
      temp = filtered;
    }
    return filtered;
  }

  function parseDate(timestamp) {
    var date = new Date(timestamp);
    var y = date.getFullYear();
    var m = (date.getMonth() + 1) < 10 ? '0' + (date.getMonth() + 1) : (date.getMonth() + 1);
    var d = date.getDate() < 10 ? '0' + date.getDate() : date.getDate();
    var H = date.getHours() < 10 ? '0' + date.getHours() : date.getHours();
    var M = date.getMinutes() < 10 ? '0' + date.getMinutes() : date.getMinutes();
    var S = date.getSeconds() < 10 ? '0' + date.getSeconds() : date.getSeconds();

    return [y, '-', m, '-', d, ' ', H, ':', M, ':', S].join('');
  }
</script>
</html>